name: OpenCode Security Scan

on:
  push:
    branches: [main]
    paths:
      - "skills/**"
      - ".gitmodules"
  pull_request:
    paths:
      - "skills/**"
      - ".gitmodules"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  opencode-security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get OpenCode version
        id: opencode_version
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(curl -sf https://api.github.com/repos/anomalyco/opencode/releases/latest | grep -o '"tag_name": *"[^"]*"' | cut -d'"' -f4)
          echo "version=${VERSION:-latest}" >> "$GITHUB_OUTPUT"

      - name: Cache OpenCode CLI
        uses: actions/cache@v4
        with:
          path: ~/.opencode/bin
          key: opencode-${{ runner.os }}-${{ runner.arch }}-${{ steps.opencode_version.outputs.version }}

      - name: Install OpenCode CLI
        shell: bash
        run: |
          set -euo pipefail
          set +e
          curl -fsSL https://opencode.ai/install | bash -s -- --no-modify-path
          install_exit=$?
          set -e
          export PATH="$HOME/.opencode/bin:$PATH"
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"
          if ! command -v opencode >/dev/null 2>&1; then
            echo "OpenCode binary not found after install"
            exit 1
          fi
          if [[ "$install_exit" -ne 0 ]]; then
            echo "OpenCode install exited non-zero ($install_exit) but binary is present; continuing"
          fi

      - name: Run OpenCode Zen security scan
        run: |
          set -euo pipefail
          mkdir -p reports
          reports_dir="$GITHUB_WORKSPACE/reports"

          targets=("$GITHUB_WORKSPACE")
          mapfile -t submodules < <(git submodule foreach --quiet --recursive 'echo $sm_path' 2>/dev/null || true)
          for sm in "${submodules[@]}"; do
            targets+=("$GITHUB_WORKSPACE/$sm")
          done

          has_issues=0
          had_errors=0

          for target in "${targets[@]}"; do
            name=$(echo "$target" | sed "s#^$GITHUB_WORKSPACE/?##; s#[/ ]#-#g; s#^-##")
            if [[ -z "$name" ]]; then
              name="root"
            fi
            out="${reports_dir}/${name}.json"
            raw="${reports_dir}/${name}.events.jsonl"

            prompt="Scan this repository for malicious code patterns and risky dependencies. Return strict JSON only with this schema: {\"summary\":{\"target\":\"${name}\",\"issues_found\":<int>},\"findings\":[{\"severity\":\"low|medium|high|critical\",\"location\":\"...\",\"summary\":\"...\",\"evidence\":\"...\"}]}"

            if ! (cd "$target" && \
              OPENCODE_PERMISSION='{"*":"allow"}' \
              opencode run --model opencode/zen --format json "$prompt" > "$raw"); then
              echo "OpenCode scan failed for $target"
              had_errors=1
              continue
            fi

            jq -r 'select(.type=="text") | .part.text' "$raw" | tail -n 1 > "$out"
            if ! jq -e '.summary and (.findings | type=="array")' "$out" >/dev/null; then
              echo "Invalid JSON schema for $target"
              had_errors=1
              continue
            fi

            issues=$(jq -r '.summary.issues_found // (.findings | length)' "$out")
            if [[ "$issues" != "0" ]]; then
              has_issues=1
            fi
          done

          shopt -s nullglob
          report_files=(reports/*.json)
          if [[ ${#report_files[@]} -gt 0 ]]; then
            jq -s '{generated_at: (now | todate), results: .}' "${report_files[@]}" \
              > reports/opencode-security.json
          fi

          if [[ "$had_errors" -ne 0 ]]; then
            echo "One or more scans failed"
            exit 1
          fi

          if [[ "$has_issues" -ne 0 ]]; then
            echo "Security findings detected"
            exit 1
          fi

      - name: Upload OpenCode security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opencode-security-reports
          path: reports

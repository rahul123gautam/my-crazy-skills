name: OpenCode Security Scan

"on":
  push:
    branches: [main]
    paths:
      - "skills/**"
      - ".gitmodules"
  pull_request:
    paths:
      - "skills/**"
      - ".gitmodules"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  opencode-security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get OpenCode version
        id: opencode_version
        shell: bash
        run: |
          set -euo pipefail
          json="$(curl -fsSL https://api.github.com/repos/anomalyco/opencode/releases/latest || true)"
          VERSION="$(jq -r '.tag_name // "latest"' <<<"$json" 2>/dev/null || echo latest)"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Cache OpenCode CLI
        uses: actions/cache@v4
        with:
          path: ~/.opencode/bin
          key: opencode-${{ runner.os }}-${{ runner.arch }}-${{ steps.opencode_version.outputs.version }}

      - name: Install OpenCode CLI
        shell: bash
        run: |
          set -euo pipefail
          set +e
          curl -fsSL https://opencode.ai/install | bash -s -- --no-modify-path
          install_exit=$?
          set -e
          export PATH="$HOME/.opencode/bin:$PATH"
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"
          if ! command -v opencode >/dev/null 2>&1; then
            echo "OpenCode binary not found after install"
            exit 1
          fi
          if [[ "$install_exit" -ne 0 ]]; then
            echo "OpenCode install exited non-zero ($install_exit) but binary is present; continuing"
          fi

      - name: Run OpenCode Zen security scan
        id: scan
        run: |
          set -euo pipefail
          mkdir -p reports
          reports_dir="$GITHUB_WORKSPACE/reports"

          targets=("$GITHUB_WORKSPACE")
          mapfile -t submodules < <(git submodule foreach --quiet --recursive 'echo $sm_path' 2>/dev/null || true)
          for sm in "${submodules[@]}"; do
            targets+=("$GITHUB_WORKSPACE/$sm")
          done

          has_issues=0
          had_errors=0
          total_critical=0
          total_high=0
          total_medium=0
          total_low=0

          for target in "${targets[@]}"; do
            name=$(echo "$target" | sed "s#^$GITHUB_WORKSPACE/?##; s#[/ ]#-#g; s#^-##")
            if [[ -z "$name" ]]; then
              name="root"
            fi
            out="${reports_dir}/${name}.json"
            raw="${reports_dir}/${name}.events.jsonl"

            prompt="Scan this repository for malicious code patterns and risky dependencies. Return strict JSON only with this schema: {\"summary\":{\"target\":\"${name}\",\"issues_found\":<int>},\"findings\":[{\"severity\":\"low|medium|high|critical\",\"location\":\"...\",\"summary\":\"...\",\"evidence\":\"...\"}]}. Do not add any extra text, code fences, or markdown."

            echo "Scanning $target..."
            if ! (cd "$target" && \
              OPENCODE_PERMISSION='{"*":"allow"}' \
              OPENCODE_DISABLE_MODELS_FETCH=true \
              OPENCODE_ENABLE_EXPERIMENTAL_MODELS=true \
              opencode run --model opencode/big-pickle --format json "$prompt" > "$raw"); then
              echo "::error::OpenCode scan failed for $target"
              had_errors=1
              continue
            fi
            python3 -c 'import json,re,sys
from pathlib import Path
raw_path=Path(sys.argv[1])
out_path=Path(sys.argv[2])
texts=[]
for line in raw_path.read_text().splitlines():
    try: obj=json.loads(line)
    except json.JSONDecodeError: continue
    if obj.get("type")=="text":
        text=(obj.get("part") or {}).get("text") or ""
        if text: texts.append(text)
def extract_json(text):
    try: return json.loads(text)
    except json.JSONDecodeError: pass
    m=re.search(r"(\\{.*?\\}|\\[.*?\\])", text, re.DOTALL)
    if m:
        try: return json.loads(m.group(1))
        except json.JSONDecodeError: return None
    return None
data=None
for text in texts:
    data=extract_json(text)
    if data is not None: break
if data is None: raise SystemExit("No JSON object found in OpenCode output")
out_path.write_text(json.dumps(data))' "$raw" "$out"
            if ! jq -e '.summary.target and (.findings | type=="array") and all(.findings[]; .severity and (.severity|IN("low","medium","high","critical")) and .location and .summary)' "$out" >/dev/null; then
              echo "::error::Invalid JSON schema for $target"
              had_errors=1
              continue
            fi

            issues=$(jq -r '(.summary.issues_found // (.findings | length)) | tonumber? // 0' "$out")
            if [[ "$issues" -ne 0 ]]; then
              has_issues=1
              critical=$(jq '[.findings[] | select(.severity=="critical")] | length' "$out")
              high=$(jq '[.findings[] | select(.severity=="high")] | length' "$out")
              medium=$(jq '[.findings[] | select(.severity=="medium")] | length' "$out")
              low=$(jq '[.findings[] | select(.severity=="low")] | length' "$out")

              total_critical=$((total_critical + critical))
              total_high=$((total_high + high))
              total_medium=$((total_medium + medium))
              total_low=$((total_low + low))

              echo "::warning::Found $issues security issues in $target (Critical: $critical, High: $high, Medium: $medium, Low: $low)"
            else
              echo "âœ… No security issues found in $target"
            fi
          done

          shopt -s nullglob
          report_files=(reports/*.json)
          if [[ ${#report_files[@]} -gt 0 ]]; then
            jq -s '{generated_at: (now | todate), results: .}' "${report_files[@]}" \
              > reports/opencode-security.json
          fi

          echo "critical=$total_critical" >> "$GITHUB_OUTPUT"
          echo "high=$total_high" >> "$GITHUB_OUTPUT"
          echo "medium=$total_medium" >> "$GITHUB_OUTPUT"
          echo "low=$total_low" >> "$GITHUB_OUTPUT"
          echo "has_issues=$has_issues" >> "$GITHUB_OUTPUT"

          if [[ "$had_errors" -ne 0 ]]; then
            echo "::error::One or more scans failed"
            exit 1
          fi

          if [[ "$has_issues" -ne 0 ]]; then
            echo "::error::Security findings detected"
            exit 1
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ”’ OpenCode Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f reports/opencode-security.json ]]; then
            total_findings=$(jq '[.results[].findings[]] | length' reports/opencode-security.json)
            
            if [[ "$total_findings" -eq 0 ]]; then
              echo "âœ… **No security issues found!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Found $total_findings security finding(s)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Severity Breakdown" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ”´ Critical: ${{ steps.scan.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸŸ  High: ${{ steps.scan.outputs.high }}" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸŸ¡ Medium: ${{ steps.scan.outputs.medium }}" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ”µ Low: ${{ steps.scan.outputs.low }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“Š Download the detailed report from the artifacts section below." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Scan failed to generate reports" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload OpenCode security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opencode-security-reports
          path: reports
          retention-days: 30

name: Auto-Add Trending Skills

on:
  # Run weekly on Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      search_query:
        description: 'Search query for skills repositories'
        required: false
        default: 'topic:ai-skill OR topic:skill'
        type: string
      category:
        description: 'Category to add skills to'
        required: false
        default: 'general'
        type: choice
        options:
          - coding
          - frontend
          - research
          - devops
          - general

  # Trigger on issues with specific format
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Job 1: Parse issue and extract repo URLs
  parse-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    outputs:
      repo_urls: ${{ steps.extract.outputs.repo_urls }}
      should_continue: ${{ steps.extract.outputs.should_continue }}
    steps:
      - name: Parse issue for repo URLs
        id: extract
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"

          # Check if issue title contains keywords
          if [[ ! "$ISSUE_TITLE" =~ (\[ADD SKILL\]|Add Skill|add skill) ]]; then
            echo "should_continue=false" >> $GITHUB_OUTPUT
            echo "Issue title doesn't match pattern, skipping"
            exit 0
          fi

          # Extract GitHub URLs from issue body
          echo "$ISSUE_BODY" | grep -oE 'https://github\.com/[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+' > /tmp/repos.txt

          REPO_COUNT=$(wc -l < /tmp/repos.txt)

          if [[ "$REPO_COUNT" -eq 0 ]]; then
            echo "should_continue=false" >> $GITHUB_OUTPUT
            echo "No valid GitHub repository URLs found in issue"
            gh issue comment "$ISSUE_NUMBER" \
              --body "‚ö†Ô∏è No valid GitHub repository URLs found in this issue. Please format like:
              ```
              https://github.com/owner/repo
              ```"
            exit 0
          fi

          # Convert to JSON array format
          REPO_JSON=$(cat /tmp/repos.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "repo_urls=$REPO_JSON" >> $GITHUB_OUTPUT
          echo "should_continue=true" >> $GITHUB_OUTPUT

          echo "‚úÖ Found $REPO_COUNT repository URLs"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add processing label
        if: steps.extract.outputs.should_continue == 'true'
        run: |
          gh issue edit "${{ github.event.issue.number }}" \
            --add-label "automation-processing"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: Discover trending skills
  discover-trending:
    if: github.event_name != 'issues'
    runs-on: ubuntu-latest
    outputs:
      trending_repos: ${{ steps.search.outputs.trending_repos }}
    steps:
      - name: Search for trending skills repositories
        id: search
        run: |
          # Configuration
          SEARCH_QUERY="${{ github.event.inputs.search_query || 'topic:ai-skill OR topic:skill' }}"
          DAYS_AGO=30
          MIN_STARS=10

          # Calculate date range
          SINCE_DATE=$(date -d "$DAYS_AGO days ago" +%Y-%m-%d)

          # Build search query
          QUERY="${SEARCH_QUERY} created:>${SINCE_DATE} stars:>${MIN_STARS} sort:stars"

          echo "üîç Searching with query: $QUERY"
          echo "üìÖ Looking for repos created after: $SINCE_DATE"

          # Search GitHub API
          RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/search/repositories?q=${QUERY}&per_page=20")

          # Check for API errors
          API_ERROR=$(echo "$RESPONSE" | jq -r '.message // empty')
          if [[ -n "$API_ERROR" ]]; then
            echo "‚ùå API Error: $API_ERROR"
            exit 1
          fi

          # Extract repository URLs and check if they're already submodules
          TRENDING_JSON=$(echo "$RESPONSE" | jq -r '
            .items[] |
            {
              url: .html_url,
              name: .full_name,
              stars: .stargazers_count,
              description: .description,
              language: .language,
              updated: .updated_at
            }' | jq -s '.')

          TOTAL=$(echo "$TRENDING_JSON" | jq 'length')
          echo "‚úÖ Found $TOTAL trending repositories"

          echo "trending_repos=$TRENDING_JSON" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 3: Process and add skills as submodules
  process-skills:
    needs: [parse-issue, discover-trending]
    if: |
      (needs.parse-issue.result == 'success' && needs.parse-issue.outputs.should_continue == 'true') ||
      needs.discover-trending.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      added_skills: ${{ steps.add.outputs.added_skills }}
      has_changes: ${{ steps.add.outputs.has_changes }}
      pr_branch: ${{ steps.add.outputs.pr_branch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine repository URLs to process
        id: repos
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            # Use repos from issue
            REPOS_JSON="${{ needs.parse-issue.outputs.repo_urls }}"
          else
            # Use trending repos
            REPOS_JSON="${{ needs.discover-trending.outputs.trending_repos }}"
          fi

          # For trending repos, extract URLs from objects
          if echo "$REPOS_JSON" | jq -e '.[0].url' > /dev/null 2>&1; then
            REPOS_JSON=$(echo "$REPOS_JSON" | jq -r '.[].url')
          fi

          echo "$REPOS_JSON" | jq -r '.[]' > /tmp/repos_to_add.txt

          TOTAL=$(wc -l < /tmp/repos_to_add.txt)
          echo "Will process $TOTAL repositories"
          echo "repos_to_add=$TOTAL" >> $GITHUB_OUTPUT

      - name: Check existing submodules
        run: |
          # List all existing submodules
          if [[ -f .gitmodules ]]; then
            grep '^\s*url' .gitmodules | sed 's/.*= //' | sort > /tmp/existing_submodules.txt
            echo "Existing submodules:"
            cat /tmp/existing_submodules.txt
          else
            touch /tmp/existing_submodules.txt
            echo "No existing submodules"
          fi

      - name: Add skills as submodules
        id: add
        run: |
          CATEGORY="${{ github.event.inputs.category || 'general' }}"
          ISSUE_NUMBER="${{ github.event.issue.number || 'auto' }}"
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="auto-add-skills-${TIMESTAMP}"

          # Create feature branch
          git checkout -b "$BRANCH_NAME"
          echo "pr_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Track added skills
          declare -a ADDED_SKILLS=()

          while IFS= read -r REPO_URL; do
            # Skip if already exists as submodule
            if grep -qF "$REPO_URL" /tmp/existing_submodules.txt 2>/dev/null; then
              echo "‚è≠Ô∏è  Skipping existing submodule: $REPO_URL"
              continue
            fi

            # Extract repo owner and name
            REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||')
            REPO_NAME=$(basename "$REPO_URL")

            # Determine category based on repo name (fallback to selected category)
            DETECTED_CATEGORY=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | grep -oE '^(coding|frontend|research|devops|general)' || echo "$CATEGORY")
            SKILL_PATH="skills/${DETECTED_CATEGORY}/${REPO_NAME}"

            echo "‚ûï Adding: $REPO_URL -> $SKILL_PATH"

            # Add as submodule
            if git submodule add "$REPO_URL" "$SKILL_PATH" 2>&1; then
              ADDED_SKILLS+=("$REPO_URL ($DETECTED_CATEGORY)")
              echo "‚úÖ Added: $REPO_URL"
            else
              echo "‚ùå Failed to add: $REPO_URL"
            fi
          done < /tmp/repos_to_add.txt

          # Check if any changes were made
          if [[ ${#ADDED_SKILLS[@]} -eq 0 ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "added_skills=[]" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No new skills to add"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Convert to JSON array
            ADDED_JSON=$(printf '%s\n' "${ADDED_SKILLS[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "added_skills=$ADDED_JSON" >> $GITHUB_OUTPUT

            # Commit changes
            git commit -m "chore: auto-add ${#ADDED_SKILLS[@]} skill(s)

            Added skills:
            $(printf '%s\n' "${ADDED_SKILLS[@]}")

            Auto-generated by GitHub Actions"

            git push origin "$BRANCH_NAME"
            echo "‚úÖ Committed and pushed changes"
          fi

      - name: Update issue with status
        if: github.event_name == 'issues' && steps.add.outputs.has_changes == 'true'
        run: |
          ADDED_COUNT=$(echo "${{ steps.add.outputs.added_skills }}" | jq 'length')
          BRANCH="${{ steps.add.outputs.pr_branch }}"

          gh issue comment "${{ github.event.issue.number }}" \
            --body "## üöÄ Skills Addition In Progress

            ‚úÖ Successfully added **$ADDED_COUNT** skill(s) as git submodules

            ### Branch: \`$BRANCH\`

            A pull request will be created shortly for review.

            ---
            ü§ñ Processing by GitHub Actions"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle no changes
        if: steps.add.outputs.has_changes == 'false'
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            gh issue comment "${{ github.event.issue.number }}" \
              --body "## ‚ÑπÔ∏è No Changes Needed

            All requested repositories are already added as submodules.

            ---
            ü§ñ Processed by GitHub Actions"

            gh issue edit "${{ github.event.issue.number }}" \
              --remove-label "automation-processing" \
              --add-label "automation-complete"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: Create pull request
  create-pr:
    needs: process-skills
    if: needs.process-skills.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ needs.process-skills.outputs.pr_branch }}
          base: main
          title: "ü§ñ Auto-Add Skills: $(echo '${{ needs.process-skills.outputs.added_skills }}' | jq -r 'length') new skill(s)"
          body: |
            ## ü§ñ Automated Skills Addition

            This pull request was automatically created to add new skills as git submodules.

            ### üì¶ Added Skills

            $(echo '${{ needs.process-skills.outputs.added_skills }}' | jq -r '.[] | "- \(. | split(" (") | .[0]) (\(. | split(" (") | .[1] | split(")") | .[0]))"')

            ### üîç What This Does

            - Each skill is added as a git submodule to the appropriate category
            - Submodules will stay in sync with their upstream repositories
            - The existing `update-submodules.yml` workflow will keep them updated automatically

            ### ‚úÖ Review Checklist

            - [ ] Verify each skill repository is relevant and useful
            - [ ] Check that skills are assigned to correct categories
            - [ ] Ensure no duplicates or conflicting skills
            - [ ] Review skill quality and maintenance status

            ### üìä Trigger Information

            - **Trigger Type**: ${{ github.event_name == 'issues' && 'Issue Request' || 'Scheduled Discovery' }}
            - **Branch**: ${{ needs.process-skills.outputs.pr_branch }}
            - **Created**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

            ---
            ü§ñ Generated by [Auto-Add Trending Skills](.github/workflows/auto-add-skills.yml) workflow
          labels: automated,skills-addition
          draft: false
          delete-branch: true

      - name: Update issue with PR link
        if: github.event_name == 'issues'
        run: |
          # Get the PR we just created
          PR_NUMBER=$(gh pr list \
            --head "${{ needs.process-skills.outputs.pr_branch }}" \
            --base main \
            --json number \
            --jq '.[0].number')

          if [[ -n "$PR_NUMBER" ]]; then
            gh issue comment "${{ github.event.issue.number }}" \
              --body "## ‚úÖ Pull Request Created

            üìÑ **PR #${PR_NUMBER}** has been created for review!

            ### Next Steps
            - Review the pull request to verify the added skills
            - Merge if everything looks good, or request changes if needed

            ---
            üîó [View Pull Request](https://github.com/${{ github.repository }}/pull/${PR_NUMBER})
            ü§ñ Automated by GitHub Actions"

            gh issue edit "${{ github.event.issue.number }}" \
              --remove-label "automation-processing" \
              --add-label "automation-complete,pr-created"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 5: Failure handling
  handle-failure:
    needs: [process-skills, create-pr]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify failure
        if: github.event_name == 'issues'
        run: |
          gh issue comment "${{ github.event.issue.number }}" \
            --body "## ‚ùå Automation Failed

            There was an error while processing this request. Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            ---
            ü§ñ GitHub Actions encountered an error"

          gh issue edit "${{ github.event.issue.number }}" \
            --remove-label "automation-processing" \
            --add-label "automation-failed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
